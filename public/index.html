<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz App â€” JSON + Azure TTS</title>
  <style>
    :root { --bg:#f5f7fb; --ink:#1b2540; --muted:#546487; --ok:#2ecc71; --ko:#ff6b6b; --card:#ffffff; --bd:#e3e8f0; }
    * { box-sizing: border-box; }
    body { margin:0; background: var(--bg); color: var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; }
    header { position:sticky; top:0; background: rgba(245,247,251,.9); backdrop-filter: blur(6px); border-bottom: 1px solid var(--bd); }
    .wrap { max-width: 960px; margin: 0 auto; padding: 16px; }
    h1 { margin:0; font-size:1.25rem; }
    main { max-width: 960px; margin: 20px auto; padding: 0 16px 40px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .spacer { flex:1; }
    .chip { padding:6px 10px; border-radius:999px; background:#eef2f9; color:var(--muted); border:1px solid var(--bd); }
    select { background:#fff; color:var(--ink); border:1px solid var(--bd); padding:8px 10px; border-radius:10px; }
    button { padding:10px 14px; border-radius:12px; border:1px solid var(--bd); background:#fff; color:var(--ink); cursor:pointer; font-weight:600; }
    button.primary { background: linear-gradient(180deg, #6aa6ff, #3e7fff); color:#fff; border:none; }
    button.ghost { background:transparent; border:1px dashed var(--bd); color:var(--muted); }
    button:active { transform: translateY(1px); }
    .card { background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:18px; }
    .meta { color:var(--muted); font-size:.95rem; display:flex; gap:8px; flex-wrap:wrap; }
    .question { margin:10px 0 6px; font-size:1.15rem; font-weight:700; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .choices { display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); margin-top: 14px; }
    .choice { padding:10px 12px; border-radius:12px; background:#fff; border:1px solid var(--bd); text-align:left; cursor:pointer; }
    .choice.ok { background: rgba(46,204,113,.14); border-color:#2ecc71; }
    .choice.ko { background: rgba(255,107,107,.16); border-color:#ff6b6b; }
    .hint { margin-top:10px; color: var(--muted); line-height:1.55; }
    .popup { margin-top:12px; background:#f0f4ff; border:1px solid #dbe6ff; padding:12px; border-radius:12px; color:#21304f; }
    .status { margin-top: 10px; font-weight:700; }
    .status.ok { color:#1e9a57; }
    .status.ko { color:#d24b4b; }
    footer { color: var(--muted); text-align:center; margin-top: 40px; font-size: .9rem; border-top:1px solid var(--bd); padding-top:16px; }
    @media (hover:none) { button, .choice { font-size: 1.05rem; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1 class="spacer">Quiz App â€” JSON + Azure TTS</h1>
      <button id="playQuestion" class="primary">â–º Play it</button>
    </div>
    <div class="wrap row" style="padding-top:6px; padding-bottom:12px;">
      <label class="chip">Level&nbsp;
        <select id="level"><option value="A1">A1</option><option value="A2">A2</option></select>
      </label>
      <label class="chip">Language&nbsp;
        <select id="lang"><option value="en">English</option><option value="ja">æ—¥æœ¬èª</option></select>
      </label>
      <label class="chip">Voice&nbsp;
        <select id="voice">
          <option value="en-GB-LibbyNeural">ğŸ‡¬ğŸ‡§ Libby (British Female)</option>
          <option value="en-GB-RyanNeural">ğŸ‡¬ğŸ‡§ Ryan (British Male)</option>
          <option value="en-US-AriaNeural" selected>ğŸ‡ºğŸ‡¸ Aria (American Female â€“ gentle)</option>
          <option value="en-US-GuyNeural">ğŸ‡ºğŸ‡¸ Guy (American Male)</option>
          <option value="en-AU-NatashaNeural">ğŸ‡¦ğŸ‡º Natasha (Australian Female)</option>
          <option value="en-AU-WilliamNeural">ğŸ‡¦ğŸ‡º William (Australian Male)</option>
        </select>
      </label>
      <span class="chip" id="pos">â€“ / â€“</span>
      <button id="prevBtn">â—€ Prev</button>
      <button id="nextBtn">Next â–¶</button>
      <span class="chip">Tip: tap once on mobile before audio</span>
    </div>
  </header>

  <main>
    <section id="quiz" class="card">
      <div id="meta" class="meta"></div>
      <div id="question" class="question">Loadingâ€¦</div>

      <div class="actions">
        <button id="showHints">ğŸ’¡ Hints</button>
        <button id="showExplain" class="ghost">â“ What does it mean?</button>
      </div>

      <div id="hints" class="hint" style="display:none;"></div>
      <div id="choices" class="choices"></div>
      <div id="status" class="status"></div>
      <div id="explain" class="popup" style="display:none;"></div>
    </section>

    <footer>
      Quiz App Â© 2025 â€” Developed by <b>Professor Hitoshi Eguchi</b> Â· Hokusei Gakuen University, Sapporo
    </footer>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const localize = (b, lang) => b ? (typeof b === 'string' ? b : (lang === 'ja' ? b.ja : b.en)) : '';

    async function speakAzure(text, lang, voice) {
      const body = { text, lang };
      if (lang === 'en' && voice) body.voice = voice;
      const r = await fetch('/api/tts', {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
      });
      if (!r.ok) throw new Error('TTS failed');
      const buf = await r.arrayBuffer();
      const blob = new Blob([buf], {type:'audio/mpeg'});
      const url = URL.createObjectURL(blob);
      let audio=document.getElementById('audio');
      if(!audio){audio=document.createElement('audio');audio.id='audio';document.body.appendChild(audio);}
      audio.src=url; await audio.play();
    }

    let data={A1:[],A2:[]}, pool=[], idx=0, lang='en', current=null;

    async function load(){
      const [a1,a2]=await Promise.all([
        fetch('/data/quizData_A1.json').then(r=>r.json()),
        fetch('/data/quizData_A2.json').then(r=>r.json())
      ]);
      data={A1:a1,A2:a2};
    }

    function pickPool(){ pool=($('#level').value==='A1')?data.A1:data.A2; idx=0; }

    function render(){
      if(!pool.length){$('#question').textContent='No items found.';$('#choices').innerHTML='';$('#pos').textContent='â€“ / â€“';return;}
      current=pool[idx];
      $('#pos').textContent=`${idx+1} / ${pool.length}`;
      $('#meta').innerHTML=`<span>${localize(current.category,lang)} â€º ${localize(current.subcategory,lang)}</span><span>Â·</span><span>${localize(current.topic?.title,lang)}</span>`;
      $('#question').textContent=localize(current.question,lang);
      $('#hints').style.display='none'; $('#hints').innerHTML=(current.hints||[]).map(h=>'â€¢ '+localize(h,lang)).join('<br>');
      $('#explain').style.display='none'; $('#status').textContent='';
      const choices=current.choices||[]; const correct=localize(current.correctAnswer,lang).trim().toLowerCase();
      const box=$('#choices'); box.innerHTML='';
      choices.forEach(ch=>{
        const text=localize(ch,lang);
        const b=document.createElement('button');
        b.className='choice'; b.textContent=text;
        b.onclick=()=>{const ok=text.trim().toLowerCase()===correct;b.className='choice '+(ok?'ok':'ko');const el=$('#status');if(ok){el.className='status ok';el.textContent='Correct! âœ“';}else{el.className='status ko';el.textContent='Try again.';}};
        box.appendChild(b);
      });
    }

    // âœ… Updated explanation function â€” shows Japanese translation
    function explain(){
      if (current && current.question && typeof current.question === 'object' && current.question.ja) {
        return `æ—¥æœ¬èªè¨³ï¼š${current.question.ja}`;
      }
      return 'æ—¥æœ¬èªè¨³ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚';
    }

    async function main(){
      await load(); lang=$('#lang').value; pickPool(); render();
      $('#level').onchange=()=>{pickPool();render();};
      $('#lang').onchange=()=>{lang=$('#lang').value;render();};
      $('#prevBtn').onclick=()=>{if(!pool.length)return;idx=Math.max(0,idx-1);render();};
      $('#nextBtn').onclick=()=>{if(!pool.length)return;idx=Math.min(pool.length-1,idx+1);render();};
      $('#playQuestion').onclick=async()=>{if(!current)return;const txt=localize((current.tts&&current.tts.questionText)||current.question,lang);const voice=$('#voice').value;try{await speakAzure(txt,lang,voice);}catch(e){alert('Audio error');console.error(e);}};
      $('#showHints').onclick=()=>{$('#hints').style.display=$('#hints').style.display==='none'?'block':'none';};
      $('#showExplain').onclick=()=>{$('#explain').textContent=explain();$('#explain').style.display='block';};
    }
    main().catch(e=>{document.body.insertAdjacentHTML('beforeend',`<pre class="card" style="white-space:pre-wrap;color:#b00000;border-color:#ffc0c0;background:#fff5f5">Error: ${String(e)}</pre>`);console.error(e);});
  </script>
</body>
</html>
